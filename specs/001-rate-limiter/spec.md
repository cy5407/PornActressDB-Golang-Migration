# Feature Specification: Web Scraper Rate Limiter

**Feature Branch**: `001-rate-limiter`  
**Created**: 2025-10-12  
**Status**: Draft  
**Input**: User description: "建立爬蟲速率限制器，支援每個網域獨立的請求頻率控制，使用 token bucket 演算法，確保遵守各網站的爬取限制"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本速率限制保護 (Priority: P1)

系統管理員希望爬蟲系統能夠自動控制對每個網站的請求頻率，避免因請求過於頻繁而被目標網站封鎖或限制存取。

**Why this priority**: 這是速率限制器的核心功能，沒有這個功能，爬蟲系統可能會因違反網站政策而被封鎖，導致整個系統無法運作。

**Independent Test**: 可以通過配置限制規則（例如：JAVDB 每秒 1 個請求），然後在短時間內發送多個請求，驗證系統是否正確延遲請求以符合限制。

**Acceptance Scenarios**:

1. **Given** 系統配置 JAVDB 網域的限制為每秒 1 個請求，**When** 在 1 秒內發送 3 個請求到 JAVDB，**Then** 第 1 個請求立即執行，第 2 個請求延遲 1 秒後執行，第 3 個請求延遲 2 秒後執行
2. **Given** 系統同時配置多個網域（JAVDB: 1 req/s, AV-WIKI: 2 req/s），**When** 同時向兩個網域發送請求，**Then** 每個網域獨立限流，互不影響

---

### User Story 2 - 網域獨立限流管理 (Priority: P1)

開發人員需要為不同的資料來源（JAVDB、AV-WIKI、chiba-f）設定不同的請求頻率限制，因為每個網站有不同的容忍度和政策。

**Why this priority**: 不同網站有不同的限流要求，統一限流會導致效率低下或違反特定網站的政策。這是必需的基礎功能。

**Independent Test**: 配置三個網域的不同限流規則，並行發送請求到這三個網域，驗證每個網域的限流設定是否獨立生效且互不干擾。

**Acceptance Scenarios**:

1. **Given** 配置了三個網域的不同限流規則（JAVDB: 1 req/s, AV-WIKI: 2 req/s, chiba-f: 1 req/s），**When** 並行向三個網域各發送 5 個請求，**Then** 每個網域按照各自的限流規則執行，總執行時間符合預期
2. **Given** 新增一個尚未配置的網域，**When** 向該網域發送請求，**Then** 系統使用預設限流規則（例如：1 req/s）

---

### User Story 3 - 爬蟲任務可控中斷 (Priority: P2)

操作人員需要能夠在爬蟲任務執行過程中安全地中斷或停止任務，而不會導致資源洩漏或請求卡住。

**Why this priority**: 在長時間執行的爬蟲任務中，能夠優雅地停止任務對於系統維護和資源管理非常重要，但不是最核心的限流功能。

**Independent Test**: 啟動一個會發送 100 個請求的爬蟲任務，在執行到第 10 個請求時發送中斷信號，驗證系統是否立即停止新請求並正確清理資源。

**Acceptance Scenarios**:

1. **Given** 正在執行的爬蟲任務已排隊 50 個請求，**When** 使用者發送停止信號，**Then** 當前正在執行的請求完成後，系統立即停止處理剩餘請求
2. **Given** 停止後的限流器實例，**When** 系統重新啟動新任務，**Then** 限流器正確重置並開始新的限流計數

---

### User Story 4 - 限流統計和監控 (Priority: P3)

系統管理員希望能夠查看每個網域的請求統計資訊，包括總請求數、被限流延遲的請求數、平均等待時間等，以便評估爬蟲效率和調整限流參數。

**Why this priority**: 統計資訊對於系統優化很有幫助，但不影響核心限流功能的運作。

**Independent Test**: 執行一組爬蟲任務後，查詢統計資訊，驗證記錄的請求數、延遲數、等待時間是否準確。

**Acceptance Scenarios**:

1. **Given** 完成了一次爬蟲任務（發送了 50 個請求，其中 30 個被限流延遲），**When** 查詢統計資訊，**Then** 系統顯示：總請求數 50、延遲請求數 30、平均等待時間準確
2. **Given** 多個網域的統計資訊，**When** 查詢特定網域的統計，**Then** 系統正確返回該網域的獨立統計資料

---

### Edge Cases

- **高並發場景**：當系統同時處理 100+ 個並發請求到同一網域時，限流器是否能正確處理且不會出現競態條件？
- **網域配置變更**：在爬蟲任務執行過程中動態修改某個網域的限流配置，正在排隊的請求應該如何處理？
- **系統時間異常**：系統時間發生跳變（向前或向後）時，限流器的計時邏輯是否還能正常工作？
- **零配置或無效配置**：如果配置檔案缺失或格式錯誤，系統應該使用安全的預設值還是拒絕啟動？
- **長時間閒置**：限流器長時間（數小時）沒有請求後，第一個新請求是否能立即執行？
- **記憶體壓力**：在記憶體受限的環境下（例如：容器限制 200MB），限流器的記憶體佔用是否可控？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須支援為每個網域（domain）獨立配置請求頻率限制
- **FR-002**: 系統必須使用 token bucket 演算法實作限流邏輯，確保請求平滑分佈
- **FR-003**: 系統必須支援以下限流配置參數：
  - 每秒最大請求數（requests per second）
  - Token bucket 容量（burst capacity）
  - Token 恢復速率（refill rate）
- **FR-004**: 系統必須為尚未配置的網域提供安全的預設限流規則（預設：1 請求/秒）
- **FR-005**: 系統必須支援並發安全，多個 goroutine 同時請求相同網域時不會出現競態條件
- **FR-006**: 系統必須支援基於 context 的取消機制，允許優雅地中斷等待中的請求
- **FR-007**: 系統必須記錄每個網域的請求統計資訊：
  - 總請求數
  - 被限流延遲的請求數
  - 平均等待時間
  - 最後請求時間
- **FR-008**: 系統必須在請求被限流時，精確計算並執行必要的等待時間
- **FR-009**: 系統必須支援從配置系統載入網域限流規則
- **FR-010**: 系統必須確保限流器的記憶體佔用低於 10MB（在管理 100 個網域的情況下）

### Key Entities

- **RateLimiter**: 速率限制器主體，管理所有網域的限流狀態
  - 屬性：網域對映表、預設限流配置、全域統計資訊
  - 職責：根據網域分配限流器實例、提供統計查詢介面
  
- **DomainLimiter**: 單一網域的限流器
  - 屬性：網域名稱、token bucket 狀態（可用 token 數、最後更新時間）、限流配置（速率、容量）
  - 職責：執行 token bucket 演算法、計算等待時間、記錄請求統計
  
- **LimitConfig**: 限流配置
  - 屬性：請求速率（requests per second）、burst 容量、token 恢復速率
  - 職責：定義單一網域的限流參數

- **LimitStats**: 限流統計資訊
  - 屬性：總請求數、延遲請求數、總等待時間、最後請求時間
  - 職責：記錄和彙總網域的請求統計

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 限流器能夠準確控制請求頻率，誤差在 ±50ms 以內（在 1 秒間隔的情況下）
- **SC-002**: 系統支援至少 10 個網域的並發限流，每個網域獨立且互不影響
- **SC-003**: 在 100 個並發請求的情況下，限流器不會出現競態條件或請求遺失
- **SC-004**: 限流器的記憶體佔用在管理 100 個網域時不超過 10MB
- **SC-005**: 從配置到第一個請求執行，系統初始化時間小於 100ms
- **SC-006**: 使用 context 取消機制時，正在等待的請求能在 100ms 內響應取消信號
- **SC-007**: 限流統計資訊的準確率達到 100%（請求數、延遲數、等待時間）
- **SC-008**: 系統能在 JAVDB（1 req/s）、AV-WIKI（2 req/s）、chiba-f（1 req/s）三個網域的配置下，正確執行 1000 個請求，總執行時間符合限流規則預期（誤差 ±5%）

## Assumptions *(mandatory)*

- 系統運作在穩定的時間源環境下（不考慮極端的系統時間跳變場景）
- 網域配置在系統啟動時載入，運行時不需要動態重新載入（未來可擴展）
- 限流器使用的記憶體快取不需要持久化到磁碟
- 統計資訊只在記憶體中維護，系統重啟後統計資訊重置
- **使用者明確要求使用 token bucket 演算法**（記錄於原始功能描述），這是一個約束條件而非任意的實作選擇
- 預設限流規則設定為 1 請求/秒，burst 容量為 1（最保守的設定）
- 系統不需要支援分散式限流（只在單一程序內有效）

## Dependencies *(mandatory)*

### External Dependencies

- **Rate Limiting Algorithm**: 使用 token bucket 演算法（使用者明確要求，記錄於功能描述）
- **Concurrency Coordination**: 需要並發錯誤處理和協調機制
- **Configuration System**: 依賴現有的配置管理模組

### Internal Dependencies

- 無（這是第一個被重構的獨立模組）

## Risks *(optional)*

### Technical Risks

- **風險 1**: Token bucket 演算法在極高並發（1000+ goroutines）下的效能表現
  - **緩解措施**: 使用 `golang.org/x/time/rate` 的經過驗證的實作，並透過壓力測試驗證效能
  
- **風險 2**: 不同網域的限流配置差異過大，可能導致資源分配不均
  - **緩解措施**: 在配置驗證階段檢查配置合理性，並提供警告訊息

- **風險 3**: Context 取消機制可能在某些情況下無法及時響應
  - **緩解措施**: 在等待邏輯中使用 `select` 優先處理 context.Done() 信號

### Business Risks

- **風險 1**: 如果限流參數設定不當（過於寬鬆），仍可能導致被目標網站封鎖
  - **緩解措施**: 提供保守的預設值，並在文件中明確說明各網站的建議配置

## Out of Scope *(optional)*

以下功能不在本次規格範圍內，可能在未來版本中考慮：

- **分散式限流**: 跨多個程序或機器的協調限流
- **動態配置重載**: 在運行時修改限流配置而不需要重啟系統
- **統計資訊持久化**: 將統計資訊儲存到資料庫或檔案
- **自適應限流**: 根據目標網站的回應自動調整限流參數
- **限流器熱插拔**: 在運行時新增或移除網域限流器
- **進階統計分析**: 請求時間分佈圖、趨勢分析等視覺化功能
