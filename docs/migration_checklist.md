# SQLite 至 JSON 遷移完成檢查清單

**版本**: 1.0
**日期**: 2025-10-17
**專案**: 女優分類系統 - 資料庫遷移
**分支**: 001-sqlite-to-json-conversion

---

## 📋 遷移流程總覽

此檢查清單提供 SQLite 至 JSON 資料庫完整遷移的逐步指南。請依序完成每個階段,並在完成後勾選對應項目。

---

## 階段一:遷移前準備

### 1.1 環境檢查
- [ ] 確認 Python 版本 (3.8+)
- [ ] 確認所有相依套件已安裝 (`pip install -r requirements.txt`)
- [ ] 確認有足夠的磁碟空間 (建議至少 2GB)
- [ ] 確認目前位於正確的 Git 分支 (`001-sqlite-to-json-conversion`)

### 1.2 備份現有資料
- [ ] 找到 SQLite 資料庫檔案位置
      預設路徑: `C:\Users\{USERNAME}\Documents\ActressClassifier\actress_database.db`
- [ ] 建立 SQLite 資料庫完整備份
  ```bash
  # 複製整個資料庫檔案到安全位置
  copy "C:\Users\{USERNAME}\Documents\ActressClassifier\actress_database.db" "C:\Users\{USERNAME}\Documents\ActressClassifier\backup\actress_database_backup_YYYYMMDD.db"
  ```
- [ ] 驗證備份檔案完整性 (檔案大小、可讀性)
- [ ] 記錄備份檔案路徑和時間戳: ___________________________

### 1.3 驗證 SQLite 資料完整性
- [ ] 檢查資料庫統計資訊
  ```bash
  python check_database.py
  ```
- [ ] 記錄 SQLite 資料統計:
  - 影片總數: _________ 部
  - 女優總數: _________ 位
  - 關聯記錄數: _________ 筆
  - 片商數量: _________ 間
- [ ] 檢查是否有損壞的記錄或異常資料

### 1.4 測試備份恢復
- [ ] 嘗試從備份檔案恢復到測試環境
- [ ] 驗證恢復後的資料完整性
- [ ] 確認備份可用且無損壞

---

## 階段二:執行遷移

### 2.1 準備 JSON 資料庫目錄
- [ ] 確認 JSON 資料庫目錄存在 (`data/json_db/`)
- [ ] 清空或備份現有 JSON 資料 (若有)
- [ ] 確認目錄權限正確 (可讀寫)

### 2.2 執行遷移工具
- [ ] 執行遷移命令
  ```bash
  python scripts/migrate_sqlite_to_json.py --sqlite-path "C:\Users\{USERNAME}\Documents\ActressClassifier\actress_database.db" --output-dir "data/json_db" --validate
  ```
- [ ] 記錄遷移開始時間: ___________________________
- [ ] 監控遷移進度和日誌輸出
- [ ] 確認無錯誤訊息或警告

### 2.3 檢查遷移輸出
- [ ] 確認 `data.json` 檔案已建立
- [ ] 檢查 `data.json` 檔案大小是否合理
- [ ] 確認初始備份已建立 (`data/json_db/backup/backup_*.json`)
- [ ] 記錄遷移完成時間: ___________________________
- [ ] 記錄總耗時: _________ 秒

---

## 階段三:遷移後驗證

### 3.1 驗證記錄計數一致性
- [ ] 檢查 JSON 資料庫統計資訊
  ```bash
  python scripts/migrate_sqlite_to_json.py --validate-only --output-dir "data/json_db"
  ```
- [ ] 記錄 JSON 資料統計:
  - 影片總數: _________ 部
  - 女優總數: _________ 位
  - 關聯記錄數: _________ 筆
- [ ] **驗證計數一致性**:
  - [ ] 影片總數一致 (SQLite = JSON)
  - [ ] 女優總數一致 (SQLite = JSON)
  - [ ] 關聯記錄數一致 (SQLite = JSON)

### 3.2 驗證資料完整性
- [ ] 隨機抽樣 10 筆影片記錄,比對 SQLite 與 JSON 內容
  - [ ] 樣本 1: _________
  - [ ] 樣本 2: _________
  - [ ] 樣本 3: _________
  - [ ] 樣本 4: _________
  - [ ] 樣本 5: _________
  - [ ] 樣本 6: _________
  - [ ] 樣本 7: _________
  - [ ] 樣本 8: _________
  - [ ] 樣本 9: _________
  - [ ] 樣本 10: _________
- [ ] 檢查外鍵完整性 (所有 video_id 和 actress_id 都有效)
- [ ] 檢查必需欄位是否完整 (title, studio, release_date 等)
- [ ] 檢查特殊字元和編碼 (日文、中文字元)

### 3.3 執行查詢測試
- [ ] 測試女優統計查詢
  ```python
  from src.models.json_database import JSONDBManager
  db = JSONDBManager('data/json_db')
  stats = db.get_actress_statistics()
  print(f"女優統計: {len(stats)} 位")
  ```
- [ ] 測試片商統計查詢
  ```python
  stats = db.get_studio_statistics()
  print(f"片商統計: {len(stats)} 間")
  ```
- [ ] 測試交叉統計查詢
  ```python
  stats = db.get_enhanced_actress_studio_statistics()
  print(f"交叉統計: {len(stats)} 筆")
  ```
- [ ] 比對查詢結果與 SQLite 版本是否一致

---

## 階段四:系統整合測試

### 4.1 功能完整性測試
- [ ] 執行單元測試套件
  ```bash
  pytest tests/test_json_statistics.py -v
  ```
- [ ] 測試 CRUD 操作
  - [ ] 新增影片記錄
  - [ ] 查詢影片資訊
  - [ ] 更新影片資料
  - [ ] 刪除影片記錄
- [ ] 測試女優 CRUD 操作
  - [ ] 新增女優記錄
  - [ ] 查詢女優資訊
  - [ ] 更新女優資料
  - [ ] 刪除女優記錄

### 4.2 效能基準測試
- [ ] 執行效能測試
  ```bash
  python test_statistics_simple.py
  ```
- [ ] 記錄查詢效能:
  - 女優統計查詢時間: _________ 秒
  - 片商統計查詢時間: _________ 秒
  - 交叉統計查詢時間: _________ 秒
- [ ] 確認查詢效能符合要求 (<1 秒)

### 4.3 並行安全性測試
- [ ] 測試多執行緒讀操作
- [ ] 測試讀寫並行操作
- [ ] 測試檔案鎖定機制
- [ ] 確認無死鎖或競爭條件

### 4.4 錯誤處理測試
- [ ] 測試損壞資料的處理
- [ ] 測試無效輸入的處理
- [ ] 測試檔案權限錯誤
- [ ] 測試磁碟空間不足情況

---

## 階段五:更新系統配置

### 5.1 更新配置檔案
- [ ] 修改 `config.ini` 檔案
  ```ini
  [database]
  json_data_dir = data/json_db
  ```
- [ ] 移除 SQLite 相關配置項 (可選)
- [ ] 驗證配置檔案語法正確

### 5.2 更新應用程式碼
- [ ] 確認所有匯入語句使用 `json_database.py`
- [ ] 確認無殘留的 SQLite 相依
- [ ] 更新日誌和錯誤訊息

### 5.3 更新文檔
- [ ] 更新 `README.md` 中的資料庫說明
- [ ] 更新 `CLAUDE.md` 中的架構文檔
- [ ] 更新 `docs/database_guide.md` (若存在)

---

## 階段六:清理與歸檔

### 6.1 驗證 JSON 資料庫可靠性
- [ ] 執行 7 天觀察期,監控 JSON 資料庫運作
- [ ] 記錄任何異常或問題: ___________________________
- [ ] 確認所有功能正常運作
- [ ] 使用者驗收測試通過

### 6.2 SQLite 檔案處理 (可選)
- [ ] **選項 A**: 保留 SQLite 檔案作為長期備份
- [ ] **選項 B**: 移動 SQLite 檔案到歸檔目錄
- [ ] **選項 C**: 刪除 SQLite 檔案 (需經過批准)
- [ ] 記錄處理決策: ___________________________

### 6.3 清理臨時檔案
- [ ] 刪除遷移過程中產生的臨時檔案
- [ ] 清理舊的備份檔案 (保留最近 30 天)
- [ ] 檢查磁碟空間使用情況

### 6.4 歸檔遷移記錄
- [ ] 儲存此檢查清單的完成版本
- [ ] 歸檔所有遷移日誌
- [ ] 建立遷移總結報告
- [ ] 更新專案文檔

---

## 階段七:故障排除指南

### 常見問題與解決方案

#### 問題 1: 遷移工具執行失敗
**症狀**: 遷移命令執行時出現錯誤
**解決方案**:
1. 檢查 SQLite 檔案路徑是否正確
2. 確認目錄權限 (可讀寫)
3. 檢查磁碟空間是否足夠
4. 查看詳細錯誤日誌 (`logs/migration.log`)

#### 問題 2: 記錄計數不一致
**症狀**: JSON 資料庫的記錄數與 SQLite 不符
**解決方案**:
1. 重新執行驗證命令 (`--validate`)
2. 檢查 SQLite 資料庫是否在遷移期間被修改
3. 從備份恢復並重新執行遷移
4. 檢查過濾條件 (是否過濾了某些記錄)

#### 問題 3: 查詢結果異常
**症狀**: 統計查詢返回空結果或異常數據
**解決方案**:
1. 檢查 `data.json` 檔案格式
2. 驗證 JSON 結構完整性
3. 檢查日誌中的警告訊息
4. 測試單一查詢並逐步排查

#### 問題 4: 效能問題
**症狀**: 查詢速度過慢 (>2 秒)
**解決方案**:
1. 檢查資料量大小
2. 優化查詢邏輯
3. 考慮增加快取機制
4. 檢查磁碟 I/O 效能

#### 問題 5: 檔案鎖定錯誤
**症狀**: 出現 "無法獲得鎖定" 錯誤
**解決方案**:
1. 確認無其他程序正在存取資料庫
2. 刪除殘留的 `.lock` 檔案
3. 檢查檔案權限
4. 增加鎖定超時時間

### 資料恢復步驟

如果遷移失敗需要回退到 SQLite:

1. **停止所有應用程式實例**
2. **恢復 SQLite 備份**
   ```bash
   copy "backup\actress_database_backup_YYYYMMDD.db" "C:\Users\{USERNAME}\Documents\ActressClassifier\actress_database.db"
   ```
3. **恢復原始配置檔案**
   ```bash
   git checkout config.ini
   ```
4. **驗證 SQLite 資料庫可用**
   ```bash
   python check_database.py
   ```
5. **檢查應用程式功能正常**
6. **分析失敗原因並記錄**

---

## 簽署確認

### 遷移執行者

- **姓名**: ___________________________
- **日期**: ___________________________
- **簽名**: ___________________________
- **備註**: ___________________________

### 遷移驗證者

- **姓名**: ___________________________
- **日期**: ___________________________
- **簽名**: ___________________________
- **備註**: ___________________________

### 技術審查者

- **姓名**: ___________________________
- **日期**: ___________________________
- **簽名**: ___________________________
- **備註**: ___________________________

---

## 附錄

### A. 遷移統計總結

- 總影片數: _________ 部
- 總女優數: _________ 位
- 總關聯記錄: _________ 筆
- 遷移耗時: _________ 秒
- 資料一致性: ☑ 通過 / ☐ 失敗
- 效能測試: ☑ 通過 / ☐ 失敗
- 功能測試: ☑ 通過 / ☐ 失敗

### B. 相關文件

- [T011 實施報告](../T011_IMPLEMENTATION_REPORT.md)
- [遷移工具使用指南](../scripts/migrate_sqlite_to_json.py)
- [JSON 資料庫 API 文檔](../src/models/json_database.py)
- [查詢等效性文檔](./query_equivalence.md)

### C. 聯絡資訊

如遇到問題,請聯絡:
- **技術支援**: ___________________________
- **專案負責人**: ___________________________

---

**檢查清單版本**: 1.0
**最後更新**: 2025-10-17
**狀態**: ☐ 未開始 / ☐ 進行中 / ☐ 已完成
